name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-client:
    name: Build Client
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-client-${{ hashFiles('client/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-client-
      - name: Install dependencies
        working-directory: ./client
        run: npm ci --legacy-peer-deps --force
      - name: Rebuild Rollup binaries
        working-directory: ./client
        run: |
          npm rebuild rollup --force
          npm ls @rollup/rollup-linux-x64-gnu || npm install @rollup/rollup-linux-x64-gnu --force
      - name: Build client
        working-directory: ./client
        run: npm run build

  build-server:
    name: Build Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          # Cache depends on package-lock.json which is missing in server, so we skip specific path or rely on default behavior
          # If we want to cache, we should commit package-lock.json. For now, we will attempt to cache but without strict path if possible, 
          # or simply remove cache-dependency-path if it causes hard failure. 
          # The error was "specified paths were not resolved", so removing the explicit path is the fix.
          # However, default cache requires package-lock.json at root.
          # Safest to just remove 'cache' for server or point to package.json (but npm cache keys off lockfile).
          # Let's run without cache for server for now to fix the specific error.
      - run: npm install
        working-directory: ./server
      # No build script for server, just checking install correctness

  build-services:
    name: Build Service
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [alert-engine, price-updater, analytics-service, oracle-service, sentiment-service]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'
      - name: Build ${{ matrix.service }}
        run: go build -v ./...
        working-directory: ./services/${{ matrix.service }}
